---
title: "HNSCC scRNA - QC & Batch Correction"
author: "Koushika R"
date: "2026-02-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/GSE181919_HNSCC")
```


#Define Directories & Study ID
```{r define_directories}
outputDir <- "~/GSE181919_HNSCC/output"
plotDir   <- "~/GSE181919_HNSCC/plots"
study_id  <- "GSE181919"
```


# Load Packages
```{r load_packages}
library(Seurat)
library(SeuratDisk)
library(dplyr)
library(ggplot2)
library(ggExtra)
library(RColorBrewer)
library(openxlsx)
library(scales)
library(HGNChelper)
library(dittoSeq)
library(harmony)
library(zellkonverter)
library(SingleCellExperiment)
library(glue)

cat("Seurat version:", as.character(packageVersion("Seurat")), "\n")
```


#Load Raw Seurat Object
```{r load_seurat}
seurat_combined <- readRDS(file = paste0("~/GSE181919_HNSCC/output/01_GSE181919_seurat_raw.rds"))

seurat_combined <- UpdateSeuratObject(seurat_combined)
# UpdateSeuratObject() converts the object to the current Seurat version format.
# This is necessary when an object was created/saved with an older version of Seurat
# (e.g., Seurat v4) and is being loaded in a newer version (e.g., Seurat v5).
# Seurat v5 introduced a new internal 'Assay5' class which is incompatible with
# the old 'Assay' class — skipping this step causes coercion errors on load.



# Explore Combined Seurat Object
cat("Class:", class(seurat_combined), "\n")
cat("Assays:", paste(names(seurat_combined@assays), collapse = ", "), "\n")
cat("Default assay:", DefaultAssay(seurat_combined), "\n")
cat("Dimensions:", paste(dim(seurat_combined), collapse = " genes x "), "cells\n")
cat("Metadata columns:\n")
print(colnames(seurat_combined@meta.data))
```

# Check for Duplicate Genes

```{r check_duplicates}
n_dups <- sum(duplicated(rownames(GetAssayData(seurat_combined, layer = "counts"))))
cat("Duplicate genes:", n_dups, "\n")

# If 0 duplicates, proceed directly
# clean_seurat_list not needed here — already a single merged object
cat("No duplicate genes found. Proceeding with seurat_combined.\n")
```


# Calculate QC Metrics

```{r calculate_qc_metrics}
# Mitochondrial gene percentage — marker of dying/stressed cells
seurat_combined[["percent.mt"]] <- PercentageFeatureSet(
  seurat_combined,
  pattern = "^MT-"
)

# Ribosomal gene percentage — high values indicate low info content
seurat_combined[["percent.rb"]] <- PercentageFeatureSet(
  seurat_combined,
  pattern = "^RPL|^RPS"
)

cat("QC metrics added.\n")
cat("\nMitochondrial % summary:\n")
print(summary(seurat_combined$percent.mt))

cat("\nRibosomal % summary:\n")
print(summary(seurat_combined$percent.rb))

cat("\nMetadata columns now:\n")
print(colnames(seurat_combined@meta.data))
```


# Pre-QC Violin Plots (by sample.id)

```{r preqc_violin_plots}
save_violin_plots_separate <- function(
  seurat_obj,
  plotDir,
  study_id,
  prefix = "preQC",
  features = c("nCount_RNA", "nFeature_RNA", "percent.mt", "percent.rb")
) {
  if (!dir.exists(plotDir)) dir.create(plotDir, recursive = TRUE)
  meta <- seurat_obj@meta.data
  meta$sample <- as.factor(meta$sample.id)

  for (feat in features) {
    if (!feat %in% colnames(meta)) {
      warning(paste("Skipping", feat, "- not found in metadata"))
      next
    }

    p <- ggplot(meta, aes(x = sample, y = .data[[feat]], fill = tissue.type)) +
      geom_violin(trim = TRUE, alpha = 0.7) +
      geom_boxplot(width = 0.1, outlier.shape = NA, alpha = 0.6, fill = "white") +
      scale_fill_manual(values = c(
        "NL" = "#4DAF4A",
        "LP" = "#FF7F00",
        "CA" = "#E41A1C",
        "LN" = "#984EA3"
      )) +
      labs(
        title = paste0(study_id, " | ", prefix, " | ", feat),  # ← matches filename exactly
        x     = "Sample",
        y     = feat,
        fill  = "Tissue Type"
      ) +
      theme_bw(base_size = 14) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title  = element_text(hjust = 0.5, face = "bold")
      )

    ggsave(
      filename = file.path(plotDir, paste0(study_id, "_", prefix, "_", feat, "_violin.png")),
      plot   = p,
      width  = 20,
      height = 9,
      dpi    = 400,
      bg     = "white"
    )
    cat("Saved:", paste0(study_id, "_", prefix, "_", feat, "_violin.png\n"))
  }
}

save_violin_plots_separate(seurat_combined, plotDir, study_id, prefix = "preQC")
```


# Pre-QC Scatter Plot (nCount vs nFeature)

```{r preqc_scatter_plot}
# Scatter plot colored by tissue.type (NL/LP/CA/LN)
density_scatter_plot <- function(seurat_obj, filename, color_by = "tissue.type", title = "") {
  df <- data.frame(
    log1p_nCount_RNA   = log1p(seurat_obj$nCount_RNA),
    log1p_nFeature_RNA = log1p(seurat_obj$nFeature_RNA),
    Group = seurat_obj@meta.data[[color_by]]
  )
  p <- ggplot(df, aes(x = log1p_nCount_RNA, y = log1p_nFeature_RNA, colour = Group)) +
    geom_point(alpha = 0.3, size = 0.5) +
    scale_color_manual(values = c(
      "NL" = "#4DAF4A",
      "LP" = "#FF7F00",
      "CA" = "#E41A1C",
      "LN" = "#984EA3"
    )) +
    theme_minimal() +
    theme(
      legend.position.inside = c(0.05, 0.95),
      legend.justification   = c("left", "top"),
      legend.key.size        = unit(0.5, "cm"),
      plot.title             = element_text(hjust = 0.5, face = "bold")  # ← centered bold title
    ) +
    guides(color = guide_legend(override.aes = list(size = 5))) +
    labs(
      title  = title,                  # ← title passed as argument
      x      = "log1p(nCount_RNA)",
      y      = "log1p(nFeature_RNA)",
      colour = "Tissue Type"
    )
  p <- ggMarginal(p, type = "histogram", fill = "skyblue", bins = 40)
  ggsave(filename, plot = p, width = 8, height = 10, dpi = 400, bg = "white")
  cat("Saved:", filename, "\n")
}

density_scatter_plot(
  seurat_obj = seurat_combined,
  filename   = file.path(plotDir, paste0(study_id, "_preQC_density-scatter.png")),
  title      = paste0(study_id, " | preQC | Density Scatter")   # ← matches filename
)
```


# Define QC Filter Functions

```{r define_qc_functions}
# Remove cells with abnormal total RNA counts using Mahalanobis distance
fil_nCounts <- function(seurat_obj, threshold_mahalanobis) {
  ncounts_data <- as.data.frame(seurat_obj@meta.data$nCount_RNA)
  colnames(ncounts_data) <- "nCount_RNA"

  mahalanobis_dist <- mahalanobis(
    x      = ncounts_data,
    center = colMeans(ncounts_data),
    cov    = cov(ncounts_data)
  )

  seurat_obj$mahal_dist_nCount <- mahalanobis_dist
  mahal.fil <- qchisq(threshold_mahalanobis, df = ncol(ncounts_data))
  message(paste0("Mahalanobis threshold: ", round(mahal.fil, 3)))

  cells_to_remove <- rownames(seurat_obj@meta.data)[seurat_obj$mahal_dist_nCount > mahal.fil]
  message(paste0("Removing ", length(cells_to_remove), " cells (outliers by nCount_RNA)"))

  return(subset(seurat_obj, cells = setdiff(colnames(seurat_obj), cells_to_remove)))
}

# Filter by gene count (removes empty droplets and likely doublets)
filter_nFeatures <- function(seurat_obj, min_feat, max_feat) {
  return(subset(seurat_obj, subset = nFeature_RNA > min_feat & nFeature_RNA < max_feat))
}

# Filter high mitochondrial RNA (dying/stressed cells)
filter_mt <- function(seurat_obj, max_mt) {
  return(subset(seurat_obj, subset = percent.mt < max_mt))
}

# Filter high ribosomal RNA (low information content)
filter_rb <- function(seurat_obj, max_rb) {
  return(subset(seurat_obj, subset = percent.rb < max_rb))
}

cat("QC filter functions defined.\n")
```
```{r check_rb}
# Check ribosomal % distribution before deciding threshold
cat("Ribosomal % summary:\n")
print(summary(seurat_combined$percent.rb))

# See exact percentiles
cat("\nPercentiles:\n")
quantile(seurat_combined$percent.rb, 
         probs = c(0.10, 0.25, 0.50, 0.75, 0.90, 0.95, 0.99))

# How many cells would be removed at different thresholds?
cat("\nCells REMOVED at different rb thresholds:\n")
for (thresh in c(10, 20, 30, 40, 50, 60)) {
  n_removed <- sum(seurat_combined$percent.rb >= thresh)
  n_kept    <- sum(seurat_combined$percent.rb < thresh)
  cat(paste0("  >", thresh, "%: removes ", n_removed, 
             " cells, keeps ", n_kept, " cells\n"))
}
```

# Apply QC Filters

```{r apply_qc_filters}
min_features          <- 200   # Remove empty droplets (<200 genes)
max_features          <- 8000  # Remove likely doublets (>8000 genes)
max_percent_mt        <- 15    # Remove dying cells (>15% mitochondrial)
# max_percent_rb      <- NOT APPLIED for HNSCC
# Ribosomal filtering is skipped — HNSCC tumor cells naturally have
# high ribosomal gene expression due to active protein synthesis
# in malignant, fibroblast, and immune cell populations.
# Applying an rb filter would remove biologically meaningful cells.
threshold_mahalanobis <- 0.95  # Remove worst 5% outliers by nCount

# Record cells before QC
cells_before <- ncol(seurat_combined)
cat("Cells before QC:", cells_before, "\n")

# Apply filters sequentially
seurat_filtered <- filter_nFeatures(seurat_combined, min_features, max_features)
cat("After nFeature filter:", ncol(seurat_filtered), "cells\n")

seurat_filtered <- filter_mt(seurat_filtered, max_percent_mt)
cat("After MT filter:", ncol(seurat_filtered), "cells\n")

seurat_filtered <- fil_nCounts(seurat_filtered, threshold_mahalanobis)
cat("After Mahalanobis filter:", ncol(seurat_filtered), "cells\n")

cat("\nTotal cells removed:", cells_before - ncol(seurat_filtered), "\n")
cat("Cells retained:", ncol(seurat_filtered), "\n")
cat("Retention rate:", round(ncol(seurat_filtered)/cells_before*100, 1), "%\n")
```


# QC Summary Table

```{r qc_summary_table}
# Cell counts before QC per sample
df_pre_qc <- as.data.frame(table(seurat_combined$sample.id))
colnames(df_pre_qc) <- c("Sample_ID", "Cells_Before_QC")

# Cell counts after QC per sample
df_post_qc <- as.data.frame(table(seurat_filtered$sample.id))
colnames(df_post_qc) <- c("Sample_ID", "Cells_After_QC")

# Merge into summary table
final_qc_table <- merge(df_pre_qc, df_post_qc, by = "Sample_ID", all.x = TRUE)
final_qc_table$Cells_Removed  <- final_qc_table$Cells_Before_QC - final_qc_table$Cells_After_QC
final_qc_table$Retention_Rate <- round(
  final_qc_table$Cells_After_QC / final_qc_table$Cells_Before_QC * 100, 1
)

print(final_qc_table)

cat("\nTotal cells before QC:", sum(final_qc_table$Cells_Before_QC), "\n")
cat("Total cells after QC:", sum(final_qc_table$Cells_After_QC, na.rm = TRUE), "\n")

# Save QC summary
qc_metrics_file <- file.path(outputDir, paste0(study_id, "_QC_metrics.csv"))
write.csv(final_qc_table, qc_metrics_file, row.names = FALSE)
cat("Saved QC summary table to:", qc_metrics_file, "\n")
```


# Post-QC Violin & Scatter Plots

```{r postqc_plots}
# Post-QC violin plots
save_violin_plots_separate(seurat_filtered, plotDir, study_id, prefix = "postQC")

# Post-QC scatter plot
density_scatter_plot(
  seurat_obj = seurat_filtered,
  filename   = file.path(plotDir, paste0(study_id, "_postQC_density-scatter.png")),
  title      = paste0(study_id, " | postQC | Density Scatter")
)
```


# Save Filtered Seurat Object

```{r save_filtered}
saveRDS(seurat_filtered, file = paste0(outputDir, "02_GSE181919_seurat_qc_filtered.rds"))
cat("Saved: output/02_GSE181919_seurat_qc_filtered.rds\n")

cat("\n=== Post-QC Seurat Object Summary ===\n")
cat("Total cells:", ncol(seurat_filtered), "\n")
cat("Total genes:", nrow(seurat_filtered), "\n")
```


# Normalization, HVG Selection, Scaling & PCA

```{r normalization_pca}
seurat_filtered <- readRDS(file = paste0(outputDir, "02_GSE181919_seurat_qc_filtered.rds"))

cat("Normalizing data using LogNormalize method (scale factor = 10,000)...\n")
seurat_processed <- NormalizeData(seurat_filtered,
                                   normalization.method = "LogNormalize")

seurat_processed <- FindVariableFeatures(seurat_processed,
                                          selection.method = "vst",
                                          nfeatures = 2500)

seurat_processed <- ScaleData(seurat_processed)

seurat_processed <- RunPCA(seurat_processed, dims = 1:100, npcs = 100)

cat("Normalization and PCA complete.\n")
```


# Elbow Plot — Select Number of PCs

```{r elbow_plot}
stdev       <- seurat_processed[["pca"]]@stdev
var_explained <- stdev^2 / sum(stdev^2)
cum_var     <- cumsum(var_explained)

pca_var_df <- data.frame(
  PC = 1:length(stdev),
  Variance = var_explained,
  CumulativeVariance = cum_var
)

num_PCs <- min(which(cum_var >= 0.95))
cat("PCs needed to explain 95% variance:", num_PCs, "\n")

elbow_plot <- ElbowPlot(seurat_processed, ndims = 100, reduction = "pca") +
  labs(title = "PCA Elbow Plot for Dimensionality Selection")

ggsave(file.path(plotDir, paste0(study_id, "_ElbowPlot.png")),
       elbow_plot, width = 8, height = 6, bg = "white")

# Total variance explained by top 35 PCs
pca_stdev       <- seurat_processed[["pca"]]@stdev
pca_var_explained <- (pca_stdev^2) / sum(pca_stdev^2) * 100
total_var       <- sum(pca_var_explained[1:35])
cat("Total variance explained by top 35 PCs:", round(total_var, 2), "%\n")
```

```{r pc_selection}
# Check cumulative variance at key cutoffs to make informed decision
for (n in c(20, 30, 35, 40, 50, 60, 73)) {
  cat(paste0("Top ", n, " PCs → ",
             round(sum(pca_var_explained[1:n]), 2), "% variance\n"))
}
```


# UMAP & Clustering on Unintegrated (PCA) Data

```{r umap_unintegrated}
set.seed(8)

# Run UMAP on unintegrated PCA (before Harmony)
# dims = 1:50 based on elbow plot analysis (89.3% variance)
seurat_processed <- RunUMAP(seurat_processed,
                             dims      = 1:50,
                             reduction = "pca")

# Build KNN graph for clustering
seurat_processed <- FindNeighbors(seurat_processed,
                                   dims       = 1:50,
                                   reduction  = "pca",
                                   graph.name = "pca_nn")

# Find clusters at resolution 0.8
# Resolution 0.8 is a good starting point for 10 known cell types
seurat_processed <- FindClusters(seurat_processed,
                                  resolution   = 0.8,
                                  graph.name   = "pca_nn",
                                  cluster.name = "pca_clusters")

n_clusters <- length(unique(seurat_processed$pca_clusters))
cat(glue("Clustering complete. Number of clusters: {n_clusters}\n"))
cat("Dims used: 1:50 (89.3% variance)\n")
```


# Save Unintegrated Seurat Object

```{r save_unintegrated}
saveRDS(seurat_processed, file = paste0(outputDir, "03_GSE181919_seurat_pca_umap.rds"))
cat("Saved: output/03_GSE181919_seurat_pca_umap.rds\n")

# Also save as .h5ad for Python/Scanpy compatibility
merged <- JoinLayers(seurat_processed)
sce    <- as.SingleCellExperiment(merged, assay = "RNA")

cat("SCE dimensions:", paste(dim(sce), collapse = " x "), "\n")
cat("Assay names:", paste(assayNames(sce), collapse = ", "), "\n")
cat("Reduced dims:", paste(reducedDimNames(sce), collapse = ", "), "\n")

SaveH5Seurat(
  object   = seurat_processed,
  filename = file.path(outputDir, "03_GSE181919_seurat_pca_umap.h5seurat"),
  overwrite = TRUE,
  version  = "3"
)

writeH5AD(sce, file = paste0(outputDir, "03_GSE181919_seurat_pca_umap.h5ad"))
cat("Saved .h5seurat and .h5ad files.\n")
```


# Harmony Batch Correction

# We use 'patient.id' as each patient contributes multiple samples (e.g., C04 + N15 from same patient),
# so patient is the true batch source, not the individual sample.

```{r harmony_integration}
set.seed(8)
harmony_processed <- RunHarmony(seurat_processed,
                                 group.by.vars    = "patient.id",
                                 plot_convergence = TRUE)

# dims = 1:50 — consistent with PC selection (89.3% variance)
harmony_processed <- RunUMAP(harmony_processed,
                               reduction = "harmony",
                               dims      = 1:50)

# dims = 1:50 — consistent with PC selection
harmony_processed <- FindNeighbors(harmony_processed,
                                    reduction  = "harmony",
                                    dims       = 1:50,
                                    graph.name = "harmony_nn")

harmony_processed <- FindClusters(harmony_processed,
                                   graph.name   = "harmony_nn",
                                   resolution   = 0.8,
                                   cluster.name = "harmony_clusters")

n_clusters_harmony <- length(unique(harmony_processed$harmony_clusters))
cat(glue("Harmony clustering complete. Number of clusters: {n_clusters_harmony}\n"))

# Save Seurat object
saveRDS(harmony_processed,
        file    = paste0(outputDir, "04_GSE181919_harmony_corrected.rds"),
        version = 2)
cat("Saved: output/04_GSE181919_harmony_corrected.rds\n")

# Save as h5ad for Python/Scanpy compatibility
merged1     <- JoinLayers(harmony_processed)
sce_harmony <- as.SingleCellExperiment(merged1, assay = "RNA")

SaveH5Seurat(
  object    = harmony_processed,
  filename  = file.path(outputDir, "04_GSE181919_harmony_corrected.h5seurat"),
  overwrite = TRUE,
  version   = "3"
)

writeH5AD(sce_harmony, file = paste0(outputDir, "04_GSE181919_harmony_corrected.h5ad"))
cat("Saved .h5seurat and .h5ad files.\n")
```


# UMAP Visualization — Before vs After Harmony

```{r umap_plots}
# Color by tissue.type (equivalent to Condition in GSE279086)
p1 <- DimPlot(seurat_processed, reduction = "umap", group.by = "tissue.type") +
  scale_color_manual(values = c(
    "NL" = "#4DAF4A", "LP" = "#FF7F00",
    "CA" = "#E41A1C", "LN" = "#984EA3"
  )) +
  ggtitle("Uncorrected — by Tissue Type")

ggsave(file.path(plotDir, paste0("BENCHMARKING_", study_id, "_RawPCA_tissuetype.png")),
       p1, width = 8, height = 6, dpi = 600)
p1

# Color by patient.id (batch variable)
p2 <- DimPlot(seurat_processed, reduction = "umap", group.by = "patient.id") +
  ggtitle("Uncorrected — by Patient") + NoLegend()

ggsave(file.path(plotDir, paste0("BENCHMARKING_", study_id, "_RawPCA_patient.png")),
       p2, width = 7, height = 6, dpi = 600)
p2

# After Harmony — tissue type
p3 <- DimPlot(harmony_processed, reduction = "umap", group.by = "tissue.type") +
  scale_color_manual(values = c(
    "NL" = "#4DAF4A", "LP" = "#FF7F00",
    "CA" = "#E41A1C", "LN" = "#984EA3"
  )) +
  ggtitle("Harmony — by Tissue Type")

ggsave(file.path(plotDir, paste0("BENCHMARKING_", study_id, "_Harmony_tissuetype.png")),
       p3, width = 8, height = 6, dpi = 600)
p3

# After Harmony — patient
p4 <- DimPlot(harmony_processed, reduction = "umap", group.by = "patient.id") +
  ggtitle("Harmony — by Patient") + NoLegend()

ggsave(file.path(plotDir, paste0("BENCHMARKING_", study_id, "_Harmony_patient.png")),
       p4, width = 7, height = 6, dpi = 600)
p4

# Save UMAP coordinates
umap_hcoords <- Embeddings(harmony_processed, "umap")
write.csv(umap_hcoords, file = paste0(outputDir, study_id, "_umap_coordinates.csv"))
cat("UMAP coordinates saved.\n")
```


# Batch Mixing Assessment (KNN-based)

```{r batch_mixing}
compute_knn_batch_mixing <- function(seu, batch_var, reduction = "pca", dims = 1:50, k = 20) {
  if (!batch_var %in% colnames(seu@meta.data))
    stop(paste0("Metadata column '", batch_var, "' not found."))

  if (!reduction %in% Reductions(seu)) {
    message("[INFO] Running Normalize → HVG → Scale → PCA")
    seu <- NormalizeData(seu, verbose = FALSE)
    seu <- FindVariableFeatures(seu, selection.method = "vst", nfeatures = 3000)
    seu <- ScaleData(seu, verbose = FALSE)
    seu <- RunPCA(seu, npcs = max(dims), verbose = FALSE)
  }

  emb  <- Embeddings(seu, reduction = reduction)[, dims, drop = FALSE]
  nn   <- FNN::get.knn(emb, k = k)$nn.index
  labs <- seu@meta.data[[batch_var]]

  same <- sapply(seq_len(nrow(nn)), function(i) {
    mean(labs[nn[i, ]] == labs[i], na.rm = TRUE)
  })

  df <- data.frame(batch = labs, frac_same_batch = same)
  aggregate(frac_same_batch ~ batch, df, mean)
}

# Batch variable = patient.id (same as Harmony correction variable)
batch_column <- "patient.id"

mix_df <- compute_knn_batch_mixing(
  seu       = seurat_processed,
  batch_var = batch_column,
  reduction = "pca",
  dims      = 1:50,
  k         = 20
)

mix_df_harmony <- compute_knn_batch_mixing(
  seu       = harmony_processed,
  batch_var = batch_column,
  reduction = "harmony",
  dims      = 1:50,
  k         = 20
)

mix_df_combined <- rbind(
  transform(mix_df, Status = "Before"),
  transform(mix_df_harmony, Status = "Harmony")
)

# Summary
cat("Mean same-batch fraction BEFORE Harmony:",
    round(mean(mix_df$frac_same_batch), 3), "\n")
cat("Mean same-batch fraction AFTER Harmony:",
    round(mean(mix_df_harmony$frac_same_batch), 3), "\n")
cat("Reduction in batch effect:",
    round((mean(mix_df$frac_same_batch) - mean(mix_df_harmony$frac_same_batch)) /
          mean(mix_df$frac_same_batch) * 100, 1), "%\n")
```


# Batch Correction Bar Plot

```{r batch_correction_barplot}
batch_cor_plot <- ggplot(mix_df_combined,
                          aes(x = batch, y = frac_same_batch, fill = Status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  labs(
    title = paste0(study_id, " | Batch Mixing — Before vs After Harmony"),
    x     = "Patient ID",
    y     = "Mean same-batch fraction\n(lower = better mixing)"
  ) +
  scale_fill_manual(values = c(
    "Before"  = "#00CED1",   # turquoise
    "Harmony" = "#9370DB"    # purple
  )) +
  # Add reference line for perfect random mixing (1/23 patients)
  geom_hline(yintercept = 1/23,
             linetype   = "dashed",
             color      = "grey40",
             linewidth  = 0.6) +
  annotate("text",
           x     = 2,
           y     = 1/23 + 0.02,
           label = "Expected random mixing (1/23)",
           size  = 3.5,
           color = "grey40") +
  theme_minimal(base_size = 15) +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1),
    legend.title = element_blank(),
    plot.title   = element_text(face = "bold", hjust = 0.5)
  )

batch_cor_plot

ggsave(
  filename = file.path(plotDir, paste0(study_id, "_batch_correction_barplot.png")),
  plot     = batch_cor_plot,
  width    = 23,
  height   = 8,
  dpi      = 300,
  bg       = "white"
)
cat("Saved:", paste0(study_id, "_batch_correction_barplot.png\n"))
```


```{r annotation_umaps}
# Load Harmony object
harmony_processed <- readRDS(paste0("~04_GSE181919_harmony_corrected.rds"))

# Plot 1: Harmony clusters
p1 <- DimPlot(harmony_processed,
              reduction  = "umap",
              group.by   = "harmony_clusters",
              label      = TRUE,
              label.size = 3,
              pt.size    = 0.1) +
  labs(title = paste0(study_id, " | Harmony Clusters")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) +
  NoLegend()

ggsave(file.path(plotDir, paste0(study_id, "_UMAP_harmony_clusters.png")),
       p1, width = 8, height = 7, dpi = 150, bg = "white")
p1

# Plot 2: Author cell types
p2 <- DimPlot(harmony_processed,
              reduction = "umap",
              group.by  = "cell.type",
              pt.size   = 0.1) +
  labs(title = paste0(study_id, " | Author Cell Types")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

ggsave(file.path(plotDir, paste0(study_id, "_UMAP_author_celltypes.png")),
       p2, width = 10, height = 7, dpi = 150, bg = "white")
p2

# Plot 3: Tissue type
p3 <- DimPlot(harmony_processed,
              reduction = "umap",
              group.by  = "tissue.type",
              pt.size   = 0.1) +
  scale_color_manual(values = c(
    "NL" = "#4DAF4A",
    "LP" = "#FF7F00",
    "CA" = "#E41A1C",
    "LN" = "#984EA3"
  )) +
  labs(title = paste0(study_id, " | Tissue Type")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

ggsave(file.path(plotDir, paste0(study_id, "_UMAP_tissue_type.png")),
       p3, width = 9, height = 7, dpi = 150, bg = "white")
p3

# Plot 4: HPV status
p4 <- DimPlot(harmony_processed,
              reduction = "umap",
              group.by  = "hpv",
              pt.size   = 0.1) +
  labs(title = paste0(study_id, " | HPV Status")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

ggsave(file.path(plotDir, paste0(study_id, "_UMAP_hpv_status.png")),
       p4, width = 8, height = 7, dpi = 150, bg = "white")
p4

cat("All UMAP plots saved!\n")

```


